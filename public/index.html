<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ray Player â€¢ Ultra</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap');
    
    :root { --accent: #1DB954; --bg: #050505; --panel: rgba(25, 25, 25, 0.7); }
    body { background-color: var(--bg); color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; }

    /* Sidebar Transitions */
    #sidebar { 
      width: 280px; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      border-right: 1px solid rgba(255,255,255,0.03);
    }
    #sidebar.hidden-mode { width: 0; padding: 0; opacity: 0; transform: translateX(-50px); }
    
    .main-view { flex: 1; height: 100vh; overflow-y: auto; background: radial-gradient(circle at top left, #121212, #000); scroll-behavior: smooth; }
    
    /* Player Bar - Hidden by default */
    #playerBar {
      position: fixed; bottom: -150px; left: 50%; transform: translateX(-50%);
      width: 95%; max-width: 1100px; height: 95px;
      background: rgba(15, 15, 15, 0.8); backdrop-filter: blur(25px);
      border: 1px solid rgba(255,255,255,0.1); border-radius: 24px;
      transition: all 0.6s cubic-bezier(0.19, 1, 0.22, 1); z-index: 1000;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.8);
    }
    #playerBar.active { bottom: 25px; }

    /* Premium Music Card */
    .music-card {
      background: rgba(255,255,255,0.03); border-radius: 20px; padding: 16px;
      transition: all 0.4s; cursor: pointer; border: 1px solid transparent;
    }
    .music-card:hover { 
      background: rgba(255,255,255,0.08); transform: translateY(-10px);
      border-color: rgba(255,255,255,0.1);
    }
    .card-img { position: relative; overflow: hidden; border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .play-overlay {
      position: absolute; inset: 0; background: rgba(0,0,0,0.4);
      display: flex; align-items: center; justify-content: center;
      opacity: 0; transition: 0.3s;
    }
    .music-card:hover .play-overlay { opacity: 1; }
    
    input[type="range"] { accent-color: var(--accent); cursor: pointer; height: 4px; }
    .text-accent { color: var(--accent); }
    .bg-accent { background-color: var(--accent); }
    
    /* Animations */
    @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(29, 185, 84, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(29, 185, 84, 0); } 100% { box-shadow: 0 0 0 0 rgba(29, 185, 84, 0); } }
    .playing-now { animation: pulse-border 2s infinite; border: 2px solid var(--accent) !important; }
  </style>
</head>
<body class="flex">

  <aside id="sidebar" class="bg-black flex flex-col h-screen p-6 z-50">
    <div class="flex items-center gap-3 mb-10 cursor-pointer" onclick="toggleSidebar()">
      <div class="w-10 h-10 bg-accent rounded-full flex items-center justify-center">
        <i class="fab fa-spotify text-2xl text-black"></i>
      </div>
      <span class="text-xl font-bold tracking-tight">RayPlayer <span class="text-accent text-xs">v6</span></span>
    </div>

    <nav class="space-y-2 mb-8 text-gray-400 font-semibold">
      <div class="flex items-center gap-4 p-3 rounded-xl bg-white/5 text-white"><i class="fas fa-home"></i> Home</div>
      <div class="flex items-center gap-4 p-3 rounded-xl hover:bg-white/5 transition cursor-pointer" onclick="document.getElementById('searchInput').focus()"><i class="fas fa-search"></i> Search</div>
    </nav>

    <div class="flex-1 overflow-hidden flex flex-col">
      <div class="flex items-center justify-between px-2 mb-4">
        <span class="text-xs uppercase tracking-widest text-gray-500 font-bold">Your Playlist</span>
        <button onclick="clearLib()" class="text-xs text-gray-500 hover:text-red-500">Clear</button>
      </div>
      <div id="libList" class="space-y-2 overflow-y-auto pr-2 custom-scroll">
        </div>
    </div>
  </aside>

  <main class="main-view p-8 lg:p-12 pb-40">
    <header class="flex items-center gap-6 mb-12">
      <button onclick="toggleSidebar()" class="w-12 h-12 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition">
        <i class="fas fa-bars"></i>
      </button>
      <div class="relative flex-1 max-w-xl">
        <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-gray-500"></i>
        <input id="searchInput" type="text" placeholder="Search songs or artists..." 
               class="w-full bg-white/5 border border-white/5 py-4 pl-14 pr-6 rounded-2xl outline-none focus:bg-white/10 focus:border-accent/30 transition-all text-lg">
      </div>
      <button onclick="performSearch()" class="bg-white text-black px-10 py-4 rounded-2xl font-bold hover:scale-105 active:scale-95 transition">Search</button>
    </header>

    <div id="resultContainer">
      <h2 id="gridTitle" class="text-3xl font-extrabold mb-8">Featured Music</h2>
      <div id="musicGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-8">
        </div>
    </div>
  </main>

  <div id="playerBar" class="flex items-center px-8">
    <div class="flex items-center w-1/4">
      <img id="pImg" src="" class="w-16 h-16 rounded-xl object-cover shadow-2xl mr-4 border border-white/10">
      <div class="min-w-0">
        <div id="pTitle" class="text-sm font-bold truncate">Song Title</div>
        <div id="pArtist" class="text-xs text-gray-500 truncate mt-1">Artist Name</div>
      </div>
      <button onclick="toggleLike()" class="ml-4 text-gray-500 hover:text-accent transition"><i id="likeIcon" class="far fa-heart text-xl"></i></button>
    </div>

    <div class="flex-1 flex flex-col items-center">
      <div class="flex items-center gap-8 mb-2">
        <button onclick="toggleShuffle()" id="shuffleBtn" class="text-gray-500 hover:text-white transition"><i class="fas fa-random"></i></button>
        <button onclick="prevTrack()" class="text-gray-400 hover:text-white text-xl transition"><i class="fas fa-step-backward"></i></button>
        <button id="playBtn" onclick="togglePlay()" class="w-12 h-12 bg-white text-black rounded-full flex items-center justify-center hover:scale-110 active:scale-95 transition shadow-lg">
          <i class="fas fa-play ml-1"></i>
        </button>
        <button onclick="nextTrack()" class="text-gray-400 hover:text-white text-xl transition"><i class="fas fa-step-forward"></i></button>
        <button onclick="toggleRepeat()" id="repeatBtn" class="text-gray-500 hover:text-white transition"><i class="fas fa-redo"></i></button>
      </div>
      <div class="flex items-center w-full max-w-2xl gap-4">
        <span id="cTime" class="text-[10px] text-gray-500 font-mono w-10 text-right">0:00</span>
        <div class="flex-1 relative h-1 bg-white/10 rounded-full">
          <input id="seek" type="range" value="0" step="0.1" class="absolute inset-0 w-full h-full opacity-0 z-10">
          <div id="progress" class="absolute top-0 left-0 h-full bg-accent rounded-full" style="width: 0%"></div>
        </div>
        <span id="dTime" class="text-[10px] text-gray-500 font-mono w-10">0:00</span>
      </div>
    </div>

    <div class="w-1/4 flex justify-end items-center gap-4 text-gray-500">
      <i class="fas fa-volume-up text-sm"></i>
      <input id="vol" type="range" min="0" max="1" step="0.05" value="1" class="w-24">
    </div>
  </div>

  <audio id="audio" class="hidden"></audio>

  <script>
    const audio = document.getElementById('audio');
    const playerBar = document.getElementById('playerBar');
    let playlist = [];
    let currentIndex = -1;
    let repeatMode = 0; // 0: None, 1: All, 2: One
    let isShuffle = false;
    let library = JSON.parse(localStorage.getItem('ray_v6_lib') || '[]');

    // UI: Toggle Sidebar
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden-mode'); }

    // Logic: Search YouTube
    async function performSearch() {
      const query = document.getElementById('searchInput').value;
      if(!query) return;
      const grid = document.getElementById('musicGrid');
      grid.innerHTML = `<div class="col-span-full py-20 text-center"><i class="fas fa-spinner fa-spin text-5xl text-accent"></i><p class="mt-4 text-gray-500">Searching YouTube...</p></div>`;
      
      try {
        const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
        playlist = await res.json();
        renderGrid();
      } catch (e) { alert("Search Error"); }
    }

    function renderGrid() {
      const grid = document.getElementById('musicGrid');
      grid.innerHTML = playlist.map((t, i) => `
        <div class="music-card group" onclick="playMusic(${i})">
          <div class="card-img mb-4">
            <img src="${t.thumb}" class="w-full aspect-square object-cover">
            <div class="play-overlay"><div class="w-12 h-12 bg-accent rounded-full flex items-center justify-center text-black"><i class="fas fa-play ml-1"></i></div></div>
          </div>
          <h3 class="font-bold truncate text-sm">${t.title}</h3>
          <p class="text-xs text-gray-500 mt-1 truncate">${t.author}</p>
        </div>
      `).join('');
    }

    // Logic: Play Control
    async function playMusic(index, fromLib = false) {
      currentIndex = index;
      const track = fromLib ? library[index] : playlist[index];
      
      // Update UI & Show Player Bar
      document.getElementById('pImg').src = track.thumb;
      document.getElementById('pTitle').innerText = track.title;
      document.getElementById('pArtist').innerText = track.author;
      playerBar.classList.add('active');
      document.getElementById('playBtn').innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';

      try {
        const res = await fetch(`/api/stream?id=${track.id}`);
        const data = await res.json();
        audio.src = data.url;
        audio.play();
        updateBtn(true);
      } catch (e) { alert("Playback failed. Try another song."); }
    }

    function togglePlay() {
      if(!audio.src) return;
      audio.paused ? (audio.play(), updateBtn(true)) : (audio.pause(), updateUI(false));
    }

    function updateBtn(p) {
      document.getElementById('playBtn').innerHTML = p ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play ml-1"></i>';
    }

    // Logic: Skip, Repeat, Shuffle
    function nextTrack() {
      let nextIdx = currentIndex + 1;
      if(isShuffle) nextIdx = Math.floor(Math.random() * playlist.length);
      if(nextIdx >= playlist.length) nextIdx = 0;
      playMusic(nextIdx);
    }

    function prevTrack() {
      let prevIdx = currentIndex - 1;
      if(prevIdx < 0) prevIdx = playlist.length - 1;
      playMusic(prevIdx);
    }

    function toggleRepeat() {
      repeatMode = (repeatMode + 1) % 3;
      const btn = document.getElementById('repeatBtn');
      if(repeatMode === 0) btn.className = "text-gray-500";
      if(repeatMode === 1) { btn.className = "text-accent"; btn.innerHTML = '<i class="fas fa-redo"></i>'; }
      if(repeatMode === 2) { btn.className = "text-accent"; btn.innerHTML = '<i class="fas fa-redo-alt"></i> <span class="text-[8px] absolute">1</span>'; }
    }

    function toggleShuffle() {
      isShuffle = !isShuffle;
      document.getElementById('shuffleBtn').className = isShuffle ? "text-accent" : "text-gray-500";
    }

    // Logic: Library / Playlist
    function toggleLike() {
      if(currentIndex === -1) return;
      const track = playlist[currentIndex];
      const foundIdx = library.findIndex(x => x.id === track.id);
      
      if(foundIdx === -1) {
        library.push(track);
        document.getElementById('likeIcon').className = "fas fa-heart text-accent";
      } else {
        library.splice(foundIdx, 1);
        document.getElementById('likeIcon').className = "far fa-heart";
      }
      localStorage.setItem('ray_v6_lib', JSON.stringify(library));
      renderLib();
    }

    function renderLib() {
      const list = document.getElementById('libList');
      list.innerHTML = library.map((t, i) => `
        <div onclick="playMusic(${i}, true)" class="flex items-center gap-3 p-2 hover:bg-white/5 rounded-xl cursor-pointer group">
          <img src="${t.thumb}" class="w-10 h-10 rounded-lg object-cover">
          <div class="min-w-0 flex-1">
            <p class="text-xs font-bold truncate">${t.title}</p>
          </div>
          <i onclick="event.stopPropagation(); removeLib(${i})" class="fas fa-minus-circle text-gray-600 opacity-0 group-hover:opacity-100 hover:text-red-500 transition"></i>
        </div>
      `).join('');
    }

    function removeLib(i) {
      library.splice(i, 1);
      localStorage.setItem('ray_v6_lib', JSON.stringify(library));
      renderLib();
    }
    
    function clearLib() { if(confirm("Clear playlist?")) { library = []; localStorage.removeItem('ray_v6_lib'); renderLib(); } }

    // Audio Update Logic
    audio.ontimeupdate = () => {
      const pct = (audio.currentTime / audio.duration) * 100;
      document.getElementById('progress').style.width = pct + "%";
      document.getElementById('cTime').innerText = fmt(audio.currentTime);
      document.getElementById('dTime').innerText = fmt(audio.duration);
    };

    audio.onended = () => {
      if(repeatMode === 2) { audio.currentTime = 0; audio.play(); }
      else nextTrack();
    };

    function fmt(s) {
      if(!s) return "0:00";
      const m = Math.floor(s/60), sc = Math.floor(s%60);
      return `${m}:${sc < 10 ? '0' : ''}${sc}`;
    }

    document.getElementById('seek').oninput = (e) => audio.currentTime = (e.target.value / 100) * audio.duration;
    document.getElementById('vol').oninput = (e) => audio.volume = e.target.value;
    document.getElementById('searchInput').onkeypress = (e) => e.key === 'Enter' && performSearch();

    renderLib();
  </script>
</body>
</html>
