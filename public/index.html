<!DOCTYPE html>
<html lang="id" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Ray Player • Premium</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000000">

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            spotify: {
              base: '#121212',
              highlight: '#1a1a1a',
              press: '#000000',
              green: '#1ed760',
              greenHover: '#1fdf64',
              subtext: '#a7a7a7'
            }
          },
          fontFamily: {
            sans: ['"Plus Jakarta Sans"', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <style>
    /* Global Reset & Custom Scrollbar */
    :root { --sp-green: #1ed760; }
    body { background-color: #000; color: #fff; overflow: hidden; user-select: none; }
    
    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

    /* Utilities */
    .line-clamp-1 { display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    /* Spotify-like Card Hover Effect */
    .sp-card {
      background-color: #181818;
      transition: background-color 0.3s ease;
    }
    .sp-card:hover { background-color: #282828; }
    
    .play-btn-overlay {
      opacity: 0;
      transform: translateY(8px);
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: 0 8px 8px rgba(0,0,0,0.3);
    }
    .sp-card:hover .play-btn-overlay {
      opacity: 1;
      transform: translateY(0);
    }

    /* Range Slider Styling */
    input[type=range] {
      -webkit-appearance: none; background: transparent; height: 4px; border-radius: 5px; cursor: pointer;
    }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 5px;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #fff; margin-top: -4px;
      visibility: hidden; /* Show on hover group */
    }
    .group:hover input[type=range]::-webkit-slider-thumb { visibility: visible; }
    .group:hover input[type=range]::-webkit-slider-runnable-track { background: var(--sp-green); }

    /* Sidebar Resizer */
    .sidebar-active { width: 280px; }
    .sidebar-hidden { width: 72px; }
    @media (max-width: 768px) {
      .sidebar-active { position: fixed; z-index: 50; height: 100%; background: #000; }
    }

    /* Marquee Animation */
    .marquee-container { overflow: hidden; white-space: nowrap; position: relative; mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent); }
    .marquee-content { display: inline-flex; animation: marquee 12s linear infinite; }
    .marquee-content:hover { animation-play-state: paused; }
    @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

    /* Glass Player Bar */
    .glass-player {
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.1);
    }
  </style>
</head>

<body class="flex flex-col h-screen text-sm font-medium">

  <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-[9999] transition-all duration-300 opacity-0 pointer-events-none translate-y-[-20px]">
    <div class="bg-[#2e77d0] text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 font-bold">
      <i class="fas fa-info-circle"></i>
      <span id="toastMsg">Notification</span>
    </div>
  </div>

  <div class="flex flex-1 overflow-hidden">
    <aside id="sidebar" class="bg-black w-[250px] flex flex-col gap-2 p-2 transition-all duration-300 shrink-0 border-r border-white/5">
      <div class="bg-spotify-base rounded-lg p-4 space-y-4">
        <div class="flex items-center gap-1 px-2 mb-2">
          <i class="fab fa-spotify text-3xl text-spotify-green"></i>
          <span class="text-lg font-bold tracking-tight ml-1">RayPlayer</span>
        </div>
        <nav class="space-y-1">
          <button onclick="router('home')" id="nav-home" class="w-full flex items-center gap-4 px-4 py-3 text-spotify-subtext hover:text-white transition-colors font-bold">
            <i class="fas fa-house text-xl w-6"></i> Home
          </button>
          <button onclick="router('search')" id="nav-search" class="w-full flex items-center gap-4 px-4 py-3 text-spotify-subtext hover:text-white transition-colors font-bold">
            <i class="fas fa-search text-xl w-6"></i> Cari
          </button>
        </nav>
      </div>

      <div class="bg-spotify-base rounded-lg flex-1 overflow-hidden flex flex-col">
        <div class="p-4 shadow-lg z-10">
          <div class="flex items-center justify-between text-spotify-subtext hover:text-white transition cursor-pointer">
            <div class="flex items-center gap-2 font-bold">
              <i class="fas fa-layer-group text-xl"></i> Koleksi Kamu
            </div>
            <button onclick="createPlaylist()" class="hover:bg-white/10 p-2 rounded-full transition"><i class="fas fa-plus"></i></button>
          </div>
          <div class="flex gap-2 mt-4 overflow-x-auto pb-1 no-scrollbar">
            <span class="bg-[#232323] px-3 py-1 rounded-full text-xs hover:bg-[#2a2a2a] cursor-pointer transition whitespace-nowrap">Playlists</span>
            <span class="bg-[#232323] px-3 py-1 rounded-full text-xs hover:bg-[#2a2a2a] cursor-pointer transition whitespace-nowrap">Artists</span>
          </div>
        </div>
        
        <div id="sidebar-playlists" class="flex-1 overflow-y-auto px-2 space-y-1 pb-4">
          </div>
      </div>
    </aside>

    <main class="flex-1 bg-spotify-base relative overflow-y-auto rounded-lg my-2 mr-2">
      <header class="sticky top-0 z-30 px-6 py-4 flex items-center justify-between bg-black/40 backdrop-blur-md transition-colors" id="mainHeader">
        <div class="flex items-center gap-3">
          <button onclick="history.back()" class="w-8 h-8 rounded-full bg-black/70 flex items-center justify-center text-gray-300 hover:text-white cursor-not-allowed"><i class="fas fa-chevron-left"></i></button>
          <button onclick="history.forward()" class="w-8 h-8 rounded-full bg-black/70 flex items-center justify-center text-gray-300 hover:text-white cursor-not-allowed"><i class="fas fa-chevron-right"></i></button>
          
          <div id="topSearchBar" class="hidden ml-2 w-[300px] relative">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input type="text" id="searchInput" placeholder="Apa yang ingin kamu dengarkan?" 
              class="w-full bg-[#242424] rounded-full py-3 pl-10 pr-4 text-sm text-white focus:outline-none focus:ring-2 focus:ring-white border border-transparent hover:border-[#333] transition"
            >
          </div>
        </div>

        <div class="flex items-center gap-4">
          <button id="installBtn" class="hidden bg-white text-black font-bold px-4 py-1.5 rounded-full text-xs hover:scale-105 transition" onclick="installPWA()">Install App</button>
          <div class="w-8 h-8 rounded-full bg-[#535353] flex items-center justify-center border-2 border-black cursor-pointer" onclick="router('info')">
            <i class="fas fa-user text-white text-xs"></i>
          </div>
        </div>
      </header>

      <div class="absolute top-0 left-0 w-full h-[300px] bg-gradient-to-b from-[#1e4e35] to-spotify-base opacity-60 pointer-events-none z-0"></div>

      <div class="relative z-10 p-6 pb-32">
        
        <section id="view-home" class="space-y-8">
          <div>
            <h1 class="text-3xl font-bold mb-6 tracking-tight">Selamat Siang</h1>
            <div id="home-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-6">
              </div>
          </div>
        </section>

        <section id="view-search" class="hidden space-y-6">
          <h2 class="text-2xl font-bold">Hasil Pencarian</h2>
          <div id="search-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
            <div class="col-span-full text-center text-gray-400 mt-10">Ketik judul lagu di atas...</div>
          </div>
        </section>

        <section id="view-playlist" class="hidden">
          <div class="flex flex-col md:flex-row gap-6 items-end mb-8">
            <div class="w-48 h-48 md:w-56 md:h-56 shadow-2xl shrink-0">
              <img id="pl-cover-img" src="" class="w-full h-full object-cover rounded shadow-lg" alt="Playlist Cover">
            </div>
            <div class="flex flex-col gap-3">
              <span class="uppercase text-xs font-bold tracking-widest">Playlist</span>
              <h1 id="pl-title" class="text-4xl md:text-7xl font-black tracking-tighter shadow-black drop-shadow-lg">My Playlist</h1>
              <div class="text-sm text-gray-300 font-medium mt-2 flex items-center gap-1">
                <span class="font-bold text-white">RayPlayer</span> • <span id="pl-count">0 lagu</span>
              </div>
            </div>
          </div>
          
          <div class="flex items-center gap-6 mb-8">
            <button onclick="playPlaylistContext()" class="w-14 h-14 bg-spotify-green rounded-full flex items-center justify-center hover:scale-105 hover:bg-spotify-greenHover transition shadow-xl text-black">
              <i class="fas fa-play text-xl ml-1"></i>
            </button>
            <button onclick="editPlaylist()" class="text-gray-400 hover:text-white text-2xl transition"><i class="fas fa-pen"></i></button>
            <button onclick="deletePlaylist()" class="text-gray-400 hover:text-white text-2xl transition"><i class="fas fa-trash"></i></button>
          </div>

          <div class="w-full">
            <div class="grid grid-cols-[16px_1fr_auto] gap-4 text-spotify-subtext border-b border-white/10 pb-2 px-4 text-sm mb-4 uppercase tracking-wider">
              <span>#</span>
              <span>Judul</span>
              <span class="mr-4"><i class="far fa-clock"></i></span>
            </div>
            <div id="pl-songs-list" class="flex flex-col">
              </div>
          </div>
        </section>

        <section id="view-info" class="hidden max-w-2xl mx-auto mt-10">
          <div class="bg-[#181818] p-8 rounded-2xl border border-white/5 text-center">
            <img src="https://files.catbox.moe/hhbl9r.jpg" class="w-32 h-32 rounded-full mx-auto mb-6 border-4 border-[#121212] shadow-xl">
            <h2 class="text-3xl font-bold mb-2">Rayy</h2>
            <p class="text-gray-400 mb-6">Fullstack Developer • Music Enthusiast</p>
            <div class="flex justify-center gap-4">
              <a href="https://t.me/RayyAckerman" target="_blank" class="bg-[#2e77d0] hover:bg-[#3485e6] text-white px-6 py-2 rounded-full font-bold transition">Telegram</a>
              <a href="https://wa.me/6283890074416" target="_blank" class="bg-[#25D366] hover:bg-[#2ce06e] text-black px-6 py-2 rounded-full font-bold transition">WhatsApp</a>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <footer class="h-[90px] w-full glass-player fixed bottom-0 z-50 px-4 flex items-center justify-between">
    
    <div class="flex items-center gap-4 w-[30%] min-w-[180px]">
      <div class="relative group cursor-pointer" onclick="toggleMiniVideo()">
        <img id="p-thumb" src="https://via.placeholder.com/64" class="h-14 w-14 rounded bg-[#282828] object-cover shadow-lg group-hover:opacity-50 transition">
        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i class="fas fa-chevron-up"></i></div>
      </div>
      <div class="flex flex-col justify-center overflow-hidden">
        <div id="p-title-wrap" class="marquee-container w-full">
            <div class="marquee-content font-bold text-sm text-white hover:underline cursor-pointer">
              <span id="p-title" class="mr-8">Pilih lagu untuk memutar</span>
              <span id="p-title-dup">Pilih lagu untuk memutar</span>
            </div>
        </div>
        <div class="text-[11px] text-gray-400 hover:text-white hover:underline cursor-pointer transition line-clamp-1" id="p-artist">RayPlayer</div>
      </div>
      <button class="text-spotify-green hover:scale-110 transition ml-2"><i class="far fa-heart"></i></button>
    </div>

    <div class="flex flex-col items-center max-w-[40%] w-full gap-2">
      <div class="flex items-center gap-6">
        <button onclick="toggleShuffle()" id="btn-shuffle" class="text-gray-400 hover:text-white transition text-lg"><i class="fas fa-shuffle"></i></button>
        <button onclick="prev()" class="text-gray-300 hover:text-white transition text-xl"><i class="fas fa-backward-step"></i></button>
        
        <button onclick="togglePlay()" id="btn-play-main" class="w-8 h-8 bg-white rounded-full text-black flex items-center justify-center hover:scale-105 transition shadow-lg">
          <i class="fas fa-play ml-0.5 text-sm"></i>
        </button>
        
        <button onclick="next()" class="text-gray-300 hover:text-white transition text-xl"><i class="fas fa-forward-step"></i></button>
        <button onclick="cycleRepeat()" id="btn-repeat" class="text-gray-400 hover:text-white transition text-lg relative"><i class="fas fa-repeat"></i></button>
      </div>
      
      <div class="w-full flex items-center gap-2 group">
        <span id="time-cur" class="text-[11px] text-gray-400 font-mono min-w-[35px] text-right">0:00</span>
        <div class="relative flex-1 h-1 bg-[#4d4d4d] rounded-full cursor-pointer" id="prog-bar-wrap" onclick="seek(event)">
          <div id="prog-fill" class="absolute top-0 left-0 h-full bg-white rounded-full group-hover:bg-spotify-green w-0"></div>
          <div id="prog-knob" class="absolute top-1/2 -translate-y-1/2 bg-white w-3 h-3 rounded-full opacity-0 group-hover:opacity-100 shadow-md" style="left: 0%"></div>
        </div>
        <span id="time-dur" class="text-[11px] text-gray-400 font-mono min-w-[35px]">0:00</span>
      </div>
    </div>

    <div class="flex items-center justify-end gap-3 w-[30%] min-w-[180px]">
      <button onclick="toggleMiniVideo()" class="text-gray-400 hover:text-white" title="Mini Player"><i class="fas fa-tv"></i></button>
      <div class="flex items-center gap-2 w-28 group">
        <i class="fas fa-volume-high text-gray-400 text-xs"></i>
        <input type="range" id="vol-slider" min="0" max="100" value="100" class="w-full h-1 bg-gray-600 rounded-lg accent-spotify-green">
      </div>
    </div>
  </footer>

  <div id="mini-player" class="fixed bottom-28 right-5 w-[320px] aspect-video bg-black rounded-lg shadow-2xl border border-white/10 hidden z-[100] overflow-hidden group">
    <div class="absolute top-0 w-full h-8 bg-gradient-to-b from-black/80 to-transparent z-20 flex items-center justify-between px-3 opacity-0 group-hover:opacity-100 transition">
      <span class="text-[10px] font-bold">YouTube View</span>
      <button onclick="toggleMiniVideo()" class="text-white hover:text-red-500"><i class="fas fa-times"></i></button>
    </div>
    <div id="yt-host" class="w-full h-full"></div>
  </div>
  
  <div id="yt-hidden" class="fixed -top-[1000px] opacity-0 pointer-events-none w-1 h-1"></div>

  <div id="modal-pl" class="fixed inset-0 bg-black/80 z-[200] hidden flex items-center justify-center backdrop-blur-sm p-4">
    <div class="bg-[#282828] w-full max-w-md rounded-xl p-6 shadow-2xl border border-white/5">
      <h3 class="text-2xl font-bold mb-6" id="modal-title">Buat Playlist</h3>
      
      <div class="flex gap-4 mb-4">
        <div class="w-32 h-32 bg-[#181818] shadow-inner flex items-center justify-center text-4xl text-gray-600 rounded-md shrink-0 relative overflow-hidden group">
          <img id="modal-cover-prev" src="" class="absolute inset-0 w-full h-full object-cover hidden">
          <i class="fas fa-music z-0"></i>
          <div class="absolute inset-0 bg-black/60 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition cursor-pointer">
             <i class="fas fa-pen text-white text-xl"></i>
             <input type="file" id="modal-file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
          </div>
        </div>
        <div class="flex-1 space-y-3">
          <input id="modal-name" type="text" placeholder="Nama Playlist" class="w-full bg-[#3e3e3e] p-3 rounded text-white font-bold focus:outline-none focus:ring-1 focus:ring-white">
          <p class="text-xs text-gray-400">Tambahkan deskripsi opsional.</p>
        </div>
      </div>
      
      <div class="flex justify-end gap-3 mt-6">
        <button onclick="closeModal()" class="px-6 py-2 rounded-full font-bold hover:scale-105 transition text-white">Batal</button>
        <button onclick="savePlaylist()" class="bg-white text-black px-8 py-2 rounded-full font-bold hover:scale-105 transition">Simpan</button>
      </div>
    </div>
  </div>

  <div id="modal-add" class="fixed inset-0 bg-black/80 z-[200] hidden flex items-center justify-center backdrop-blur-sm p-4">
    <div class="bg-[#282828] w-full max-w-sm rounded-xl p-4 shadow-2xl max-h-[70vh] flex flex-col">
      <div class="flex justify-between items-center mb-4 pb-4 border-b border-white/10">
        <h3 class="font-bold text-lg">Tambahkan ke playlist</h3>
        <button onclick="document.getElementById('modal-add').classList.add('hidden')"><i class="fas fa-times"></i></button>
      </div>
      <div id="modal-add-list" class="flex-1 overflow-y-auto space-y-2 pr-2"></div>
      <button onclick="createPlaylist(true)" class="mt-4 bg-white/10 hover:bg-white/20 text-white w-full py-3 rounded-full font-bold transition">Playlist Baru</button>
    </div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // ================= CONFIG & STATE =================
    const STATE = {
      playlists: JSON.parse(localStorage.getItem('ray_pl_v2') || '[]'),
      history: [],
      currentPlaylistId: null,
      queue: [],
      nowPlaying: null,
      isPlaying: false,
      shuffle: false,
      repeat: 0, // 0: off, 1: all, 2: one
      miniMode: false,
      ctx: 'home' // home, search, playlist
    };
    
    let player; // YT Player Instance
    let progressInterval;

    // ================= INIT =================
    window.addEventListener('DOMContentLoaded', () => {
      renderSidebar();
      loadHome(); // Mock data for demo
      setupEventListeners();
      
      // Check PWA
      if(window.matchMedia('(display-mode: standalone)').matches) document.getElementById('installBtn').classList.add('hidden');
    });

    // ================= ROUTER & UI =================
    function router(view) {
      document.querySelectorAll('section[id^="view-"]').forEach(el => el.classList.add('hidden'));
      document.getElementById(`view-${view}`).classList.remove('hidden');
      
      // Update Sidebar Active State
      document.querySelectorAll('#sidebar nav button').forEach(btn => {
        btn.classList.remove('text-white', 'bg-[#282828]');
        btn.classList.add('text-spotify-subtext');
      });
      
      const navBtn = document.getElementById(`nav-${view === 'playlist' ? 'home' : view}`); // Highlight home for playlist too
      if(navBtn) {
        navBtn.classList.add('text-white');
        if(view !== 'playlist') navBtn.classList.remove('text-spotify-subtext');
      }

      // Special handling
      if(view === 'search') {
        document.getElementById('topSearchBar').classList.remove('hidden');
        document.getElementById('searchInput').focus();
      } else {
        document.getElementById('topSearchBar').classList.add('hidden');
      }
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      const tm = document.getElementById('toastMsg');
      tm.innerText = msg;
      t.classList.remove('opacity-0', 'translate-y-[-20px]', 'pointer-events-none');
      setTimeout(() => {
        t.classList.add('opacity-0', 'translate-y-[-20px]', 'pointer-events-none');
      }, 3000);
    }

    // ================= DATA & RENDERING =================
    
    // -- Sidebar Rendering --
    function renderSidebar() {
      const container = document.getElementById('sidebar-playlists');
      if(STATE.playlists.length === 0) {
        container.innerHTML = `<div class="p-4 text-xs text-gray-500 text-center">Belum ada playlist.<br>Buat yang pertama!</div>`;
        return;
      }
      
      container.innerHTML = STATE.playlists.map(pl => `
        <div onclick="openPlaylist('${pl.id}')" class="flex items-center gap-3 p-2 rounded-md hover:bg-[#1a1a1a] cursor-pointer group transition ${STATE.currentPlaylistId === pl.id ? 'bg-[#282828]' : ''}">
          <div class="w-12 h-12 rounded bg-[#333] shrink-0 overflow-hidden shadow-sm">
            ${pl.cover ? `<img src="${pl.cover}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center"><i class="fas fa-music text-gray-500"></i></div>'}
          </div>
          <div class="min-w-0 flex-1">
            <div class="text-white font-bold text-sm truncate group-hover:text-spotify-green transition">${esc(pl.name)}</div>
            <div class="text-xs text-gray-400 truncate">Playlist • Rayy</div>
          </div>
        </div>
      `).join('');
    }

    // -- Home (Mock Data for Demo) --
    async function loadHome() {
      // In a real app, fetch from API. simulating fetch:
      const container = document.getElementById('home-grid');
      container.innerHTML = '<div class="col-span-full flex justify-center py-20"><i class="fas fa-circle-notch fa-spin text-4xl text-spotify-green"></i></div>';
      
      // Use existing API from previous code or fallback
      try {
        const res = await fetch(`/api/search?q=musik indonesia populer`); 
        const data = await res.json();
        renderCards(data, container, 'home');
      } catch (e) {
        // Fallback demo data if API fails (since I'm AI and can't run backend)
        const demoData = Array(12).fill(0).map((_,i) => ({
          id: 'demo'+i,
          title: `Lagu Keren ${i+1}`,
          author: 'Artis Populer',
          thumb: `https://picsum.photos/seed/${i+15}/400/225`, // 16:9 Aspect
          duration: '3:45'
        }));
        renderCards(demoData, container, 'home');
      }
    }

    // -- Search --
    async function performSearch(q) {
      if(!q) return;
      const container = document.getElementById('search-grid');
      container.innerHTML = '<div class="col-span-full flex justify-center py-20"><i class="fas fa-circle-notch fa-spin text-4xl text-spotify-green"></i></div>';
      
      try {
        const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
        const data = await res.json();
        renderCards(data, container, 'search');
      } catch (e) {
        container.innerHTML = '<div class="col-span-full text-center text-red-500">Gagal memuat. Coba lagi.</div>';
      }
    }

    // -- Card Component (16:9 Aspect Ratio) --
    function renderCards(data, container, context) {
      if(!data || !data.length) {
        container.innerHTML = '<div class="col-span-full text-center text-gray-500">Tidak ada hasil.</div>';
        return;
      }
      
      STATE.queue = data; // Simple queue logic for demo

      container.innerHTML = data.map((track, idx) => `
        <div class="sp-card p-4 rounded-lg group cursor-pointer relative" onclick="playTrack(${idx}, '${context}')">
          <div class="relative w-full aspect-video rounded-md overflow-hidden mb-4 shadow-xl bg-[#282828]">
             <img src="${track.thumb}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500" loading="lazy">
             <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition duration-300"></div>
             
             <div class="absolute bottom-2 right-2 play-btn-overlay">
               <div class="w-12 h-12 rounded-full bg-spotify-green flex items-center justify-center text-black shadow-lg hover:scale-105 transition">
                 <i class="fas fa-play ml-1"></i>
               </div>
             </div>
          </div>
          
          <h3 class="font-bold text-white text-base truncate mb-1" title="${esc(track.title)}">${esc(track.title)}</h3>
          <div class="flex justify-between items-center text-sm text-gray-400">
             <span class="truncate max-w-[70%]">${esc(track.author)}</span>
             <span class="text-xs font-mono">${track.duration || ''}</span>
          </div>

          <button onclick="event.stopPropagation(); openAddToPlaylistModal(${idx})" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition bg-black/60 hover:bg-black/80 w-8 h-8 rounded-full flex items-center justify-center text-white">
            <i class="fas fa-plus text-xs"></i>
          </button>
        </div>
      `).join('');
    }

    // ================= PLAYLIST LOGIC =================
    let pendingTrack = null;

    function createPlaylist(fromAdd = false) {
      document.getElementById('modal-name').value = '';
      document.getElementById('modal-cover-prev').classList.add('hidden');
      document.getElementById('modal-file').value = '';
      STATE._tempPlId = null;
      STATE._returnToAdd = fromAdd;
      document.getElementById('modal-title').innerText = 'Buat Playlist';
      document.getElementById('modal-pl').classList.remove('hidden');
    }

    function savePlaylist() {
      const name = document.getElementById('modal-name').value.trim();
      if(!name) return showToast("Nama playlist wajib diisi");
      
      const coverSrc = document.getElementById('modal-cover-prev').src;
      const isCustomCover = !document.getElementById('modal-cover-prev').classList.contains('hidden');

      if(STATE._tempPlId) {
        // Edit Mode
        const pl = STATE.playlists.find(p => p.id === STATE._tempPlId);
        if(pl) {
          pl.name = name;
          if(isCustomCover) pl.cover = coverSrc;
          showToast("Playlist diperbarui");
          if(STATE.currentPlaylistId === pl.id) openPlaylist(pl.id); // refresh view
        }
      } else {
        // Create Mode
        const newPl = {
          id: 'pl_' + Date.now(),
          name: name,
          cover: isCustomCover ? coverSrc : null,
          songs: []
        };
        STATE.playlists.push(newPl);
        showToast("Playlist dibuat");
        
        if(STATE._returnToAdd && pendingTrack) {
           addToPlaylistReal(newPl.id, pendingTrack);
        }
      }

      localStorage.setItem('ray_pl_v2', JSON.stringify(STATE.playlists));
      renderSidebar();
      closeModal();
    }

    function openAddToPlaylistModal(idx) {
      const track = STATE.queue[idx]; // Assumes queue matches current view (simplified)
      if(!track) return;
      pendingTrack = track;
      
      const list = document.getElementById('modal-add-list');
      list.innerHTML = STATE.playlists.map(pl => `
        <div onclick="addToPlaylistReal('${pl.id}')" class="flex items-center gap-3 p-2 hover:bg-white/10 rounded cursor-pointer">
           <div class="w-10 h-10 bg-[#333] rounded overflow-hidden">
             ${pl.cover ? `<img src="${pl.cover}" class="w-full h-full object-cover">` : '<i class="fas fa-music text-gray-500 m-3"></i>'}
           </div>
           <div class="font-bold text-sm">${esc(pl.name)}</div>
        </div>
      `).join('');
      
      if(STATE.playlists.length === 0) list.innerHTML = '<div class="text-center text-gray-500 py-4">Belum ada playlist</div>';
      
      document.getElementById('modal-add').classList.remove('hidden');
    }

    function addToPlaylistReal(plId, trackObj = null) {
      const pl = STATE.playlists.find(p => p.id === plId);
      const tr = trackObj || pendingTrack;
      if(pl && tr) {
        // Check duplicate
        if(pl.songs.find(s => s.id === tr.id)) {
          showToast("Lagu sudah ada di playlist");
        } else {
          pl.songs.push(tr);
          localStorage.setItem('ray_pl_v2', JSON.stringify(STATE.playlists));
          showToast("Ditambahkan ke Playlist");
        }
      }
      document.getElementById('modal-add').classList.add('hidden');
      renderSidebar(); // update counts if we had them
    }

    function openPlaylist(id) {
      const pl = STATE.playlists.find(p => p.id === id);
      if(!pl) return;
      STATE.currentPlaylistId = id;
      
      document.getElementById('pl-title').innerText = pl.name;
      document.getElementById('pl-count').innerText = `${pl.songs.length} lagu`;
      document.getElementById('pl-cover-img').src = pl.cover || `https://via.placeholder.com/300/181818/555555?text=${encodeURIComponent(pl.name.substring(0,2).toUpperCase())}`;
      
      const list = document.getElementById('pl-songs-list');
      if(pl.songs.length === 0) {
        list.innerHTML = '<div class="py-10 text-center text-gray-500">Playlist ini kosong.<br>Cari lagu dan tambahkan ke sini.</div>';
      } else {
        list.innerHTML = pl.songs.map((s, i) => `
          <div class="group grid grid-cols-[16px_1fr_auto] gap-4 items-center p-2 rounded-md hover:bg-white/10 transition cursor-pointer" onclick="playTrack(${i}, 'playlist')">
            <div class="text-gray-400 group-hover:text-white text-xs text-center flex items-center justify-center h-full">
              <span class="group-hover:hidden">${i+1}</span>
              <i class="fas fa-play text-xs hidden group-hover:block text-white"></i>
            </div>
            <div class="flex items-center gap-3 min-w-0">
               <img src="${s.thumb}" class="w-10 h-10 object-cover rounded shadow-sm">
               <div class="min-w-0">
                 <div class="text-white font-medium text-sm truncate ${STATE.nowPlaying?.id === s.id ? 'text-spotify-green' : ''}">${esc(s.title)}</div>
                 <div class="text-gray-400 text-xs truncate">${esc(s.author)}</div>
               </div>
            </div>
            <div class="flex items-center gap-4 text-gray-400 text-xs font-mono">
              <span class="hidden md:block">${s.duration}</span>
              <button onclick="event.stopPropagation(); removeFromPlaylist('${id}', ${i})" class="hover:text-red-500 opacity-0 group-hover:opacity-100"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        `).join('');
      }
      
      router('playlist');
    }

    function removeFromPlaylist(plId, idx) {
      const pl = STATE.playlists.find(p => p.id === plId);
      if(pl) {
        pl.songs.splice(idx, 1);
        localStorage.setItem('ray_pl_v2', JSON.stringify(STATE.playlists));
        openPlaylist(plId); // Refresh UI
        showToast("Lagu dihapus");
      }
    }

    function deletePlaylist() {
      if(!confirm("Hapus playlist ini selamanya?")) return;
      STATE.playlists = STATE.playlists.filter(p => p.id !== STATE.currentPlaylistId);
      localStorage.setItem('ray_pl_v2', JSON.stringify(STATE.playlists));
      STATE.currentPlaylistId = null;
      renderSidebar();
      router('home');
      showToast("Playlist dihapus");
    }

    function editPlaylist() {
      const pl = STATE.playlists.find(p => p.id === STATE.currentPlaylistId);
      if(!pl) return;
      STATE._tempPlId = pl.id;
      document.getElementById('modal-title').innerText = 'Edit Playlist';
      document.getElementById('modal-name').value = pl.name;
      if(pl.cover) {
        document.getElementById('modal-cover-prev').src = pl.cover;
        document.getElementById('modal-cover-prev').classList.remove('hidden');
      }
      document.getElementById('modal-pl').classList.remove('hidden');
    }

    // Modal Helpers
    function closeModal() {
      document.getElementById('modal-pl').classList.add('hidden');
    }
    // File Input Preview
    document.getElementById('modal-file').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('modal-cover-prev').src = e.target.result;
          document.getElementById('modal-cover-prev').classList.remove('hidden');
        }
        reader.readAsDataURL(file);
      }
    });

    // ================= PLAYER LOGIC (YT) =================
    
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('yt-host', {
        height: '100%', width: '100%', videoId: '',
        playerVars: { 'autoplay': 1, 'controls': 0, 'rel': 0, 'playsinline': 1 },
        events: { 'onStateChange': onPlayerStateChange, 'onReady': onPlayerReady }
      });
    }
    
    function onPlayerReady(event) {
      // Sync Volume
      player.setVolume(document.getElementById('vol-slider').value);
      // Move to hidden initially
      const iframe = document.getElementById('yt-host').querySelector('iframe') || document.getElementById('yt-host');
      if(iframe) document.getElementById('yt-hidden').appendChild(iframe);
    }

    function onPlayerStateChange(event) {
      if(event.data === YT.PlayerState.PLAYING) {
        STATE.isPlaying = true;
        updatePlayerUI();
        startProgressLoop();
      } else if (event.data === YT.PlayerState.PAUSED) {
        STATE.isPlaying = false;
        updatePlayerUI();
        clearInterval(progressInterval);
      } else if (event.data === YT.PlayerState.ENDED) {
        next();
      }
    }

    function playTrack(idx, context) {
      let list = [];
      if(context === 'home') list = STATE.queue; // Assuming home fills queue
      if(context === 'search') list = STATE.queue;
      if(context === 'playlist') {
        const pl = STATE.playlists.find(p => p.id === STATE.currentPlaylistId);
        if(pl) list = pl.songs;
      }
      
      // Update Queue Reference based on context if needed (simplified here)
      STATE.queue = list;
      STATE.nowPlaying = list[idx];
      STATE._ctxIdx = idx;

      if(player && player.loadVideoById) {
        player.loadVideoById(STATE.nowPlaying.id || 'dQw4w9WgXcQ'); // Fallback ID if missing
      } else {
        // Mock play for UI only if YT not ready
        console.log("Playing mock", STATE.nowPlaying.title);
      }
      
      updatePlayerUI(true);
      showToast(`Memutar: ${STATE.nowPlaying.title}`);
    }

    function togglePlay() {
      if(!player) return;
      if(STATE.isPlaying) player.pauseVideo();
      else player.playVideo();
    }

    function next() {
      if(!STATE.queue.length) return;
      let nextIdx = STATE._ctxIdx + 1;
      
      if(STATE.shuffle) {
        nextIdx = Math.floor(Math.random() * STATE.queue.length);
      } else if(nextIdx >= STATE.queue.length) {
         if(STATE.repeat === 1) nextIdx = 0; // Loop All
         else return; // Stop
      }
      playTrack(nextIdx, 'queue'); // context 'queue' just means use current array
    }

    function prev() {
      if(!STATE.queue.length) return;
      let prevIdx = STATE._ctxIdx - 1;
      if(prevIdx < 0) prevIdx = STATE.queue.length - 1;
      playTrack(prevIdx, 'queue');
    }

    function toggleShuffle() {
      STATE.shuffle = !STATE.shuffle;
      document.getElementById('btn-shuffle').classList.toggle('text-spotify-green', STATE.shuffle);
      document.getElementById('btn-shuffle').classList.toggle('text-gray-400', !STATE.shuffle);
      // Optional: Shuffle queue array logic
    }
    
    function cycleRepeat() {
      STATE.repeat = (STATE.repeat + 1) % 3;
      const btn = document.getElementById('btn-repeat');
      // 0: off, 1: all, 2: one
      btn.className = `text-lg transition relative ${STATE.repeat > 0 ? 'text-spotify-green' : 'text-gray-400'}`;
      btn.innerHTML = STATE.repeat === 2 ? '<i class="fas fa-repeat"></i><span class="absolute -top-1 -right-1 text-[8px] font-bold">1</span>' : '<i class="fas fa-repeat"></i>';
    }

    function updatePlayerUI(fullUpdate = false) {
      const btn = document.getElementById('btn-play-main');
      btn.innerHTML = STATE.isPlaying ? '<i class="fas fa-pause text-sm"></i>' : '<i class="fas fa-play text-sm ml-0.5"></i>';
      
      if(fullUpdate && STATE.nowPlaying) {
        document.getElementById('p-title').innerText = STATE.nowPlaying.title;
        document.getElementById('p-title-dup').innerText = STATE.nowPlaying.title;
        document.getElementById('p-artist').innerText = STATE.nowPlaying.author;
        document.getElementById('p-thumb').src = STATE.nowPlaying.thumb;
        
        // Setup MediaSession
        if('mediaSession' in navigator) {
          navigator.mediaSession.metadata = new MediaMetadata({
            title: STATE.nowPlaying.title,
            artist: STATE.nowPlaying.author,
            artwork: [{ src: STATE.nowPlaying.thumb, sizes: '512x512', type: 'image/png' }]
          });
        }
      }
    }

    // -- Progress Bar --
    function startProgressLoop() {
      clearInterval(progressInterval);
      progressInterval = setInterval(() => {
        if(!player || !player.getCurrentTime) return;
        const ct = player.getCurrentTime();
        const dur = player.getDuration();
        
        if(dur) {
           const pct = (ct / dur) * 100;
           document.getElementById('prog-fill').style.width = pct + '%';
           document.getElementById('prog-knob').style.left = pct + '%';
           document.getElementById('time-cur').innerText = fmtTime(ct);
           document.getElementById('time-dur').innerText = fmtTime(dur);
        }
      }, 500);
    }

    function seek(e) {
      if(!player) return;
      const rect = document.getElementById('prog-bar-wrap').getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const pct = clickX / rect.width;
      const dur = player.getDuration();
      if(dur) {
        player.seekTo(dur * pct, true);
      }
    }

    // -- Mini Video --
    function toggleMiniVideo() {
      STATE.miniMode = !STATE.miniMode;
      const mini = document.getElementById('mini-player');
      const hidden = document.getElementById('yt-hidden');
      // Get iframe safely
      const iframe = player && player.getIframe ? player.getIframe() : document.querySelector('iframe');
      
      if(!iframe) return;

      if(STATE.miniMode) {
        mini.classList.remove('hidden');
        document.getElementById('yt-host').appendChild(iframe);
      } else {
        mini.classList.add('hidden');
        hidden.appendChild(iframe);
      }
    }

    // -- Utils --
    function fmtTime(s) {
      if(isNaN(s)) return "0:00";
      const m = Math.floor(s/60);
      const sec = Math.floor(s%60);
      return `${m}:${sec<10?'0':''}${sec}`;
    }
    
    function esc(unsafe) {
      return unsafe
           .replace(/&/g, "&amp;")
           .replace(/</g, "&lt;")
           .replace(/>/g, "&gt;")
           .replace(/"/g, "&quot;")
           .replace(/'/g, "&#039;");
    }

    // -- Events Listeners --
    function setupEventListeners() {
       document.getElementById('searchInput').addEventListener('keyup', (e) => {
         if(e.key === 'Enter') performSearch(e.target.value);
       });
       
       document.getElementById('vol-slider').addEventListener('input', (e) => {
         if(player) player.setVolume(e.target.value);
       });
       
       // Handle Search bar visibility on scroll
       document.querySelector('main').addEventListener('scroll', (e) => {
          const header = document.getElementById('mainHeader');
          if(e.target.scrollTop > 50) {
            header.classList.add('bg-black');
            header.classList.remove('bg-black/40');
          } else {
            header.classList.remove('bg-black');
            header.classList.add('bg-black/40');
          }
       });
    }

    // -- PWA Install (Simplified) --
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installBtn').classList.remove('hidden');
    });

    async function installPWA() {
      if(!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if(outcome === 'accepted') {
        deferredPrompt = null;
        document.getElementById('installBtn').classList.add('hidden');
      }
    }
  </script>
</body>
</html>
