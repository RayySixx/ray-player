<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ray Player â€¢ Ultra V7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body { 
            background-color: #000; 
            color: #fff; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
        }

        /* Sidebar Logic */
        #sidebar { 
            width: 260px; 
            transition: all 0.3s ease; 
            background: #000;
            border-right: 1px solid #282828;
        }
        #sidebar.hidden-mode { width: 0; padding: 0; opacity: 0; pointer-events: none; }

        /* Search Input Fix */
        .search-container input {
            background: #242424;
            color: white !important; /* Pastikan teks putih */
            border: 1px solid transparent;
        }
        .search-container input:focus {
            background: #2a2a2a;
            border-color: #555;
        }

        /* Player Bar - Spotify Style */
        #playerBar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 90px;
            background: #121212;
            border-top: 1px solid #282828;
            display: none; /* Hilang kalo belum play */
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
        }
        #playerBar.active { display: flex; }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            height: 4px;
            background: #4f4f4f;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }
        #progressFill {
            height: 100%;
            background: #1DB954;
            border-radius: 2px;
            width: 0%;
        }

        /* Card Music */
        .music-card {
            background: #181818;
            transition: background 0.3s ease, transform 0.2s ease;
            padding: 16px;
            border-radius: 8px;
        }
        .music-card:hover {
            background: #282828;
            transform: translateY(-5px);
        }

        .main-content {
            flex: 1;
            height: 100vh;
            overflow-y: auto;
            background: linear-gradient(to bottom, #1a1a1a, #000);
        }
    </style>
</head>
<body class="flex">

    <aside id="sidebar" class="flex flex-col h-screen p-5">
        <div class="flex items-center gap-3 mb-8 cursor-pointer" onclick="toggleSidebar()">
            <i class="fab fa-spotify text-3xl text-green-500"></i>
            <span class="text-xl font-bold">RayPlayer</span>
        </div>
        <nav class="space-y-4">
            <div class="flex items-center gap-4 text-gray-400 hover:text-white cursor-pointer transition">
                <i class="fas fa-home text-xl"></i> <span class="font-bold">Home</span>
            </div>
            <div class="flex items-center gap-4 text-gray-400 hover:text-white cursor-pointer transition" onclick="document.getElementById('searchInput').focus()">
                <i class="fas fa-search text-xl"></i> <span class="font-bold">Search</span>
            </div>
        </nav>
        <div class="mt-10">
            <p class="text-xs text-gray-500 font-bold uppercase mb-4">Library</p>
            <div id="libList" class="space-y-3 overflow-y-auto max-h-[50vh]"></div>
        </div>
    </aside>

    <main class="main-content p-6 lg:p-10 pb-32">
        <div class="flex items-center gap-4 mb-8">
            <button onclick="toggleSidebar()" class="p-2 hover:bg-white/10 rounded-full transition">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <div class="search-container flex-1 max-w-xl relative">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input id="searchInput" type="text" placeholder="Search for songs..." 
                       class="w-full py-3 pl-12 pr-4 rounded-full outline-none text-white">
            </div>
            <button onclick="searchMusic()" class="bg-white text-black px-6 py-3 rounded-full font-bold hover:scale-105 transition">
                Search
            </button>
        </div>

        <h2 id="sectionTitle" class="text-2xl font-bold mb-6">Results</h2>
        <div id="grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 xl:grid-cols-6 gap-6">
            </div>
    </main>

    <footer id="playerBar">
        <div class="flex items-center w-1/3 min-w-0">
            <img id="pImg" src="" class="w-14 h-14 rounded shadow-lg mr-4 object-cover">
            <div class="truncate">
                <div id="pTitle" class="text-sm font-bold truncate">Song Title</div>
                <div id="pArtist" class="text-xs text-gray-400 truncate">Artist</div>
            </div>
            <button onclick="saveToLib()" class="ml-4 text-gray-400 hover:text-green-500">
                <i class="far fa-heart"></i>
            </button>
        </div>

        <div class="flex flex-col items-center w-1/3">
            <div class="flex items-center gap-6 mb-2">
                <button onclick="toggleShuffle()" id="shuffleBtn" class="text-gray-400 hover:text-white"><i class="fas fa-random"></i></button>
                <button onclick="prevTrack()" class="text-gray-400 hover:text-white"><i class="fas fa-step-backward text-xl"></i></button>
                <button id="playBtn" onclick="togglePlay()" class="w-10 h-10 bg-white text-black rounded-full flex items-center justify-center hover:scale-105">
                    <i class="fas fa-play ml-1"></i>
                </button>
                <button onclick="nextTrack()" class="text-gray-400 hover:text-white"><i class="fas fa-step-forward text-xl"></i></button>
                <button onclick="toggleRepeat()" id="repeatBtn" class="text-gray-400 hover:text-white"><i class="fas fa-redo"></i></button>
            </div>
            <div class="flex items-center w-full gap-3">
                <span id="curTime" class="text-[10px] text-gray-400 w-8 text-right">0:00</span>
                <div class="progress-container flex-1" onclick="seekAudio(event)">
                    <div id="progressFill"></div>
                </div>
                <span id="durTime" class="text-[10px] text-gray-400 w-8">0:00</span>
            </div>
        </div>

        <div class="flex items-center justify-end w-1/3 gap-3">
            <i class="fas fa-volume-up text-gray-400"></i>
            <input id="volSlider" type="range" min="0" max="1" step="0.1" value="1" class="w-24 accent-green-500">
        </div>
    </footer>

    <audio id="mainAudio"></audio>

    <script>
        const audio = document.getElementById('mainAudio');
        let playlist = [];
        let currentIndex = -1;
        let isShuffle = false;
        let repeatMode = 0; // 0: none, 1: one
        let library = JSON.parse(localStorage.getItem('ray_lib') || '[]');

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('hidden-mode');
        }

        async function searchMusic() {
            const q = document.getElementById('searchInput').value;
            if(!q) return;
            const grid = document.getElementById('grid');
            grid.innerHTML = `<div class="col-span-full py-20 text-center"><i class="fas fa-spinner fa-spin text-4xl text-green-500"></i></div>`;
            
            try {
                const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
                playlist = await res.json();
                renderGrid();
            } catch (e) { alert("Search Error"); }
        }

        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = playlist.map((t, i) => `
                <div class="music-card cursor-pointer group" onclick="playTrack(${i})">
                    <div class="relative mb-4">
                        <img src="${t.thumb}" class="w-full aspect-square object-cover rounded shadow-2xl">
                        <div class="absolute bottom-2 right-2 w-10 h-10 bg-green-500 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-lg translate-y-2 group-hover:translate-y-0">
                            <i class="fas fa-play text-black"></i>
                        </div>
                    </div>
                    <div class="font-bold truncate text-sm">${t.title}</div>
                    <div class="text-xs text-gray-400 truncate mt-1">${t.author}</div>
                </div>
            `).join('');
        }

        async function playTrack(i) {
            currentIndex = i;
            const track = playlist[i];
            
            document.getElementById('pImg').src = track.thumb;
            document.getElementById('pTitle').innerText = track.title;
            document.getElementById('pArtist').innerText = track.author;
            document.getElementById('playerBar').classList.add('active');
            document.getElementById('playBtn').innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';

            try {
                const res = await fetch(`/api/stream?id=${track.id}`);
                const data = await res.json();
                if(!data.url) throw new Error();
                
                audio.src = data.url;
                audio.play();
                updateBtn(true);
            } catch (e) { 
                alert("Playback failed. Link expired or blocked."); 
                updateBtn(false);
            }
        }

        function togglePlay() {
            if(!audio.src) return;
            audio.paused ? (audio.play(), updateBtn(true)) : (audio.pause(), updateBtn(false));
        }

        function updateBtn(p) {
            document.getElementById('playBtn').innerHTML = p ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play ml-1"></i>';
        }

        function seekAudio(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            audio.currentTime = pct * audio.duration;
        }

        audio.ontimeupdate = () => {
            const pct = (audio.currentTime / audio.duration) * 100 || 0;
            document.getElementById('progressFill').style.width = pct + '%';
            document.getElementById('curTime').innerText = fmt(audio.currentTime);
            document.getElementById('durTime').innerText = fmt(audio.duration);
        };

        function fmt(s) {
            if(!s) return "0:00";
            const m = Math.floor(s/60), sc = Math.floor(s%60);
            return `${m}:${sc < 10 ? '0' : ''}${sc}`;
        }

        function nextTrack() {
            let next = currentIndex + 1;
            if(isShuffle) next = Math.floor(Math.random() * playlist.length);
            if(next < playlist.length) playTrack(next);
        }

        function prevTrack() {
            if(currentIndex > 0) playTrack(currentIndex - 1);
        }

        function toggleRepeat() {
            repeatMode = repeatMode === 0 ? 1 : 0;
            document.getElementById('repeatBtn').classList.toggle('text-green-500', repeatMode === 1);
        }

        audio.onended = () => {
            if(repeatMode === 1) audio.play();
            else nextTrack();
        };

        document.getElementById('volSlider').oninput = (e) => audio.volume = e.target.value;
        document.getElementById('searchInput').onkeypress = (e) => e.key === 'Enter' && searchMusic();

        function saveToLib() {
            if(currentIndex === -1) return;
            const t = playlist[currentIndex];
            if(!library.find(x => x.id === t.id)) {
                library.push(t);
                localStorage.setItem('ray_lib', JSON.stringify(library));
                renderLib();
            }
        }

        function renderLib() {
            const list = document.getElementById('libList');
            list.innerHTML = library.map((t, i) => `
                <div class="flex items-center gap-3 p-2 hover:bg-white/5 rounded cursor-pointer group" onclick="playLib(${i})">
                    <img src="${t.thumb}" class="w-10 h-10 rounded">
                    <div class="min-w-0 flex-1">
                        <p class="text-xs font-bold truncate">${t.title}</p>
                    </div>
                </div>
            `).join('');
        }

        function playLib(i) {
            playlist = library;
            playTrack(i);
        }

        renderLib();
    </script>
</body>
</html>
